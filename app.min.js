const DEBUG=!0;let g_xlsxData=[],g_members={},g_monthInReports=[],logger;$(document).ready(function(){const t="You need to upload 6 files for score analysis.",e={LAST_NAME:"チャプター► サマリーPALMSレポート",FIRST_NAME:"__EMPTY",ATTENDANCE:"__EMPTY_1",ABSENT:"__EMPTY_2",LATE:"__EMPTY_4",REFERRAL:"__EMPTY_8",REFERRAL2:"__EMPTY_9",VISITOR:"__EMPTY_13",TYFCB:"__EMPTY_15",CEU:"__EMPTY_16",RECOMMENDATION:"__EMPTY_17",REPORT_DATE:"__EMPTY_9",REPORT_DATE_NICE:"REPORT_DATE_NICE",LAST_NAME_NICE:"LAST_NAME_NICE",FIRST_NAME_NICE:"FIRST_NAME_NICE",ATTENDANCE_NICE:"ATTENDANCE_NICE",ABSENT_NICE:"ABSENT_NICE",LATE_NICE:"LATE_NICE",REFERRAL_NICE:"REFERRAL_NICE",REFERRAL2_NICE:"REFERRAL2_NICE",REFERRAL_FINAL:"REFERRAL_FINAL",VISITOR_NICE:"VISITOR_NICE",TYFCB_NICE:"TYFCB_NICE",CEU_NICE:"CEU_NICE",RECOMMENDATION_NICE:"RECOMMENDATION_NICE"};logger=new Logger(DEBUG),$(".file-multiple").change(function(e){r();let c=e.target.files;if(c.length!=6){i(t);return}for(let e=0,t=c.length;e<t;e++)a(c[e]);n(c),setTimeout(function(){s(),o(!0)},1e3)}),$(".export-score").click(function(){c()});function n(e=[]){let t="";for(let n=0,o=e.length;n<o;n++){let s=e[n];t+=`<li>${s.name}（${bytesToSize(s.size)}）</li>`}$(".files").html(t)}function s(){console.log(g_xlsxData);let t,f,d,l,a,r,c,s,o,p,u,h,m,n,g={},i=[];for(let s=0,o=g_xlsxData.length;s<o;s++){let n=g_xlsxData[s],t;t=n[4],t=t[e.REPORT_DATE],g_monthInReports.includes(t)||g_monthInReports.push(t),g[t]||(g[t]=n);for(let s=0,o=n.length-3;s<o;s++){if(s<7)continue;n[s][e.REPORT_DATE_NICE]=t,i.push(n[s])}}console.log(i);for(let v=0,b=i.length;v<b;v++){let g=i[v];d=g[Object.keys(g)[0]],l=g[e.FIRST_NAME],t=`${d} ${l}`,a=Number(g[e.ATTENDANCE]),r=Number(g[e.ABSENT]),c=Number(g[e.LATE]),s=Number(g[e.REFERRAL]),o=Number(g[e.REFERRAL2]),f=s+o,p=Number(g[e.VISITOR]),u=Number(g[e.TYFCB]),h=Number(g[e.CEU]),m=Number(g[e.RECOMMENDATION]),n=g[e.REPORT_DATE_NICE],g_members[t]?(a+=g_members[t][e.ATTENDANCE_NICE],r+=g_members[t][e.ABSENT_NICE],c+=g_members[t][e.LATE_NICE],s+=g_members[t][e.REFERRAL_NICE],o+=g_members[t][e.REFERRAL2_NICE],f+=g_members[t][e.REFERRAL_FINAL],p+=g_members[t][e.VISITOR_NICE],u+=g_members[t][e.TYFCB_NICE],h+=g_members[t][e.CEU_NICE],m+=g_members[t][e.RECOMMENDATION_NICE]):g_members[t]={},g_members[t][e.LAST_NAME_NICE]=d,g_members[t][e.FIRST_NAME_NICE]=l,g_members[t][e.ATTENDANCE_NICE]=a,g_members[t][e.ABSENT_NICE]=r,g_members[t][e.LATE_NICE]=c,g_members[t][e.REFERRAL_NICE]=s,g_members[t][e.REFERRAL2_NICE]=o,g_members[t][e.REFERRAL_FINAL]=f,g_members[t][e.VISITOR_NICE]=p,g_members[t][e.TYFCB_NICE]=u,g_members[t][e.CEU_NICE]=h,g_members[t][e.RECOMMENDATION_NICE]=m,g_members[t][e.REPORT_DATE_NICE]||(g_members[t][e.REPORT_DATE_NICE]={}),g_members[t][e.REPORT_DATE_NICE][n]||(g_members[t][e.REPORT_DATE_NICE][n]={}),g_members[t][e.REPORT_DATE_NICE][n][e.ATTENDANCE_NICE]=Number(g[e.ATTENDANCE]),g_members[t][e.REPORT_DATE_NICE][n][e.ABSENT_NICE]=Number(g[e.ABSENT]),g_members[t][e.REPORT_DATE_NICE][n][e.LATE_NICE]=Number(g[e.LATE]),g_members[t][e.REPORT_DATE_NICE][n][e.REFERRAL_NICE]=Number(g[e.REFERRAL]),g_members[t][e.REPORT_DATE_NICE][n][e.REFERRAL2_NICE]=Number(g[e.REFERRAL2]),g_members[t][e.REPORT_DATE_NICE][n][e.REFERRAL_FINAL]=Number(g[e.REFERRAL])+Number(g[e.REFERRAL2]),g_members[t][e.REPORT_DATE_NICE][n][e.VISITOR_NICE]=Number(g[e.VISITOR]),g_members[t][e.REPORT_DATE_NICE][n][e.TYFCB_NICE]=Number(g[e.TYFCB]),g_members[t][e.REPORT_DATE_NICE][n][e.CEU_NICE]=Number(g[e.CEU]),g_members[t][e.REPORT_DATE_NICE][n][e.RECOMMENDATION_NICE]=Number(g[e.RECOMMENDATION])}console.log(g_members)}function o(e){e=e||!1,e?$(".export-score").removeAttr("disabled"):$(".export-score").attr("disabled")}function i(e){if(!e||e==""){$(".message").hide();return}$(".message__text").text(e),$(".message").show()}function a(e){const t=new d;t.parseExcel(e)}function r(){g_xlsxData=[],g_members=[],g_monthInReports=[],$(".files").html(),$(".message").hide()}function c(){const n=new l(e),r=[["","※1　今月なにも活動しない場合の合計数値"],["","","","参加","欠席","","遅刻","","リファーラル","","ビジター","","TYFCB","","CEU","","推薦のことば","","","今月何もしなかった場合の点数"],["","","","回数","現在","※1","現在","※1","現在","※1","現在","※1","現在","※1","現在","※1","現在","※1",""],["","姓","名","","計","","計","","計","","計","","計","","計","","計","","","欠席","遅刻","リファーラル","ビジター","サンキュー金額","CEU","推薦の言葉","点数"]];for(const g in g_members){const s=g_members[g];let t=[],c=s[e.REPORT_DATE_NICE];const a=Object.keys(c).sort().reduce((e,t)=>(e[t]=c[t],e),{});let o=a[Object.keys(a)[0]];t.push(""),t.push(s[e.LAST_NAME_NICE]),t.push(s[e.FIRST_NAME_NICE]),t.push(s[e.ATTENDANCE_NICE]),t.push(s[e.ABSENT_NICE]),t.push(s[e.ABSENT_NICE]-o[e.ABSENT_NICE]),t.push(s[e.LATE_NICE]),t.push(s[e.LATE_NICE]-o[e.LATE_NICE]),t.push(s[e.REFERRAL_FINAL]),t.push(s[e.REFERRAL_FINAL]-o[e.REFERRAL_FINAL]),t.push(s[e.VISITOR_NICE]),t.push(s[e.VISITOR_NICE]-o[e.VISITOR_NICE]),t.push(s[e.TYFCB_NICE]),t.push(s[e.TYFCB_NICE]-o[e.TYFCB_NICE]),t.push(s[e.CEU_NICE]),t.push(s[e.CEU_NICE]-o[e.CEU_NICE]),t.push(s[e.RECOMMENDATION_NICE]),t.push(s[e.RECOMMENDATION_NICE]-o[e.RECOMMENDATION_NICE]),t.push("");let l=n.getScore(e.ABSENT,s[e.ABSENT_NICE]),d=n.getScore(e.LATE,s[e.LATE_NICE]),u=n.getScore(e.REFERRAL_FINAL,s[e.REFERRAL_FINAL]),h=n.getScore(e.VISITOR,s[e.VISITOR_NICE]),m=n.getScore(e.TYFCB,s[e.TYFCB_NICE]),f=n.getScore(e.CEU,s[e.CEU_NICE]),p=n.getScore(e.RECOMMENDATION,s[e.RECOMMENDATION_NICE]);t.push(l),t.push(d),t.push(u),t.push(h),t.push(m),t.push(f),t.push(p);let i=0;i=l+d+u+h+m+f+p,t.push(i),r.push(t)}const t=XLSX.utils.aoa_to_sheet(r);let x={s:{r:1,c:4},e:{r:1,c:5}},O=XLSX.utils.decode_range("G2:H2"),p=XLSX.utils.decode_range("I2:J2"),f=XLSX.utils.decode_range("K2:L2"),m=XLSX.utils.decode_range("M2:N2"),d=XLSX.utils.decode_range("O2:P2"),u=XLSX.utils.decode_range("Q2:R2"),h=XLSX.utils.decode_range("T2:AA3");t["!merges"]||(t["!merges"]=[]),t["!merges"].push(x),t["!merges"].push(O),t["!merges"].push(p),t["!merges"].push(f),t["!merges"].push(m),t["!merges"].push(d),t["!merges"].push(u),t["!merges"].push(h);var s,i=XLSX.utils.decode_range(t["!ref"]),C=i.e.r,o=i.e.c;const g={alignment:{vertical:"center",horizontal:"center"}};for(let e=i.s.r;e<=C;++e)for(let s=i.s.c;s<=o;++s){let r={c:s,r:e},a=XLSX.utils.encode_cell(r);if(!t[a])continue;if(t[a].s={...g},e>3&&s==o){let e=n.getRankColor(t[a].v);t[a].s.fill={fgColor:{rgb:e}}}e>3&&(s==5||s==7||s==9||s==11||s==13||s==15||s==17)&&(t[a].s.fill={fgColor:{rgb:"8EAADB"}}),(e>2&&(s>0&&s<18||s>18&&s<=o)||e>1&&s>2&&s<18)&&(t[a].s.border={top:{style:"thin",color:"000000"},bottom:{style:"thin",color:"000000"},left:{style:"thin",color:"000000"},right:{style:"thin",color:"000000"}}),(e==3&&s>0&&s<18||e==2&&s>2&&s<18)&&(t[a].s.fill={fgColor:{rgb:"BFBFBF"}}),e==3&&s>0&&s<18&&(t[a].s.font={bold:!0,sz:"14"})}let v=["T2","D2","E2","G2","I2","K2","M2","O2","Q2"],b=["U2","V2","W2","X2","Y2","Z2"],j=["AA2","F2","H2","J2","L2","N2","P2","R2"],y=["AA3"],_=["U3","V3","W3","X3","Y3","Z3"],w=["T3"];v.forEach(function(e){t[e]||(t[e]={s:{},v:"",t:"s"}),t[e].s={border:{top:{style:"medium",color:"000000"},left:{style:"medium",color:"000000"}}}}),b.forEach(function(e){t[e]||(t[e]={s:{},v:"",t:"s"}),t[e].s={border:{top:{style:"medium",color:"000000"}}}}),j.forEach(function(e){t[e]||(t[e]={s:{},v:"",t:"s"}),t[e].s={border:{top:{style:"medium",color:"000000"},right:{style:"medium",color:"000000"}}}}),y.forEach(function(e){t[e]||(t[e]={s:{},v:"",t:"s"}),t[e].s={border:{bottom:{style:"medium",color:"000000"},right:{style:"medium",color:"000000"}}}}),_.forEach(function(e){t[e]||(t[e]={s:{},v:"",t:"s"}),t[e].s={border:{bottom:{style:"medium",color:"000000"}}}}),w.forEach(function(e){t[e]||(t[e]={s:{},v:"",t:"s"}),t[e].s={border:{bottom:{style:"medium",color:"000000"},left:{style:"medium",color:"000000"}}}}),t.T2.s.font={color:{rgb:"FF0000"}},t.T2.s.alignment={vertical:"center",horizontal:"center"},t.B1.s.alignment={vertical:"center",horizontal:"left"},t.B1.s.font={sz:"14"},s=[];for(let e=0;e<=o;e++)e==0?s.push({wch:2}):e==1||e==2?s.push({wch:10}):s.push({wch:5});t["!cols"]=s;const a=XLSX.utils.book_new();let c="Report";a.SheetNames.push(c),a.Sheets[c]=t,XLSX.writeFile(a,`${getFirstDayOfCurrentMonth()}.xlsx`)}class l{constructor(e){this.KEY=e}getScore=function(e,t){let n=0;if(e==this.KEY.ABSENT)switch(t){case 2:n=5;break;case 1:n=10;break;case 0:n=15;break;case 3:default:n=0;break}else if(e==this.KEY.LATE)switch(t){case 1:n=0;break;case 0:n=5;break;default:n=0;break}else if(e==this.KEY.REFERRAL_FINAL)switch(t){case.75:n=5;break;case 1:n=10;break;case 1.5:n=15;break;case 2:n=20;break;default:n=0;break}else if(e==this.KEY.VISITOR)switch(t){case 2:n=5;break;case 4:n=10;break;case 6:n=15;break;case 12:n=20;break;default:n=0;break}else if(e==this.KEY.TYFCB)switch(t){case 200:n=5;break;case 500:n=10;break;case 1e3:n=15;break;default:n=0;break}else if(e==this.KEY.CEU)switch(t){case 10:n=5;break;case 15:n=10;break;case 20:n=15;break;default:n=0;break}else if(e==this.KEY.RECOMMENDATION)switch(t){case 1:n=5;break;case 2:n=10;break;default:n=0;break}return n};getRankColor=function(e){if(e==100)return"00B050";if(e>=70&&e<=95)return"92D050";if(e>=50&&e<=65)return"FFFF00";if(e>=30&&e<=45)return"FF0000";if(e>=0&&e<=25)return"BFBFBF"}}class d{parseExcel=function(e){var t=new FileReader;t.onload=function(e){var n=e.target.result,t=XLSX.read(n,{type:"binary"});t.SheetNames.forEach(function(e){var n=XLSX.utils.sheet_to_row_object_array(t.Sheets[e]),s=JSON.stringify(n);g_xlsxData.push(JSON.parse(s))})},t.onerror=function(e){console.log(e)},t.readAsBinaryString(e)}}});function extractMonth(e){const n=/年\d+月/gm;let s,t;for(;(s=n.exec(e))!==null;)s.index===n.lastIndex&&n.lastIndex++,s.forEach((e)=>{t=e});return t=t.replace("年",""),t}function bytesToSize(e){var t,n=["Bytes","KB","MB","GB","TB"];return e==0?"0 Byte":(t=parseInt(Math.floor(Math.log(e)/Math.log(1024))),Math.round(e/Math.pow(1024,t),2)+" "+n[t])}function getFirstDayOfCurrentMonth(){const t=new Date;let n=t.getFullYear(),e=t.getMonth()+1;return e=e.toString().padStart(2,"0"),`${n}${e}01`}class Logger{constructor(e){this.debug=e}info=function(...e){if(!this.debug)return;console.log(...e)};warn=function(...e){if(!this.debug)return;console.warn(...e)}}